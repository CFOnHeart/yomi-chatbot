<!DOCTYPE html>
<html>
<head>
    <title>å·¥å…·ç¡®è®¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>å·¥å…·ç¡®è®¤æµ‹è¯•é¡µé¢</h1>
    <button onclick="startTest()">å¼€å§‹æµ‹è¯•å·¥å…·ç¡®è®¤</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    
    <h3>äº‹ä»¶æ—¥å¿—:</h3>
    <div id="log" class="log"></div>
    
    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function startTest() {
            log('å¼€å§‹æµ‹è¯•å·¥å…·ç¡®è®¤...');
            
            const eventSource = new EventSource('http://localhost:8000/chat/stream?session_id=tool-test&message=calculate 15 multiply 23');
            
            eventSource.onopen = function() {
                log('âœ… SSEè¿æ¥å·²å»ºç«‹');
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    log(`æ”¶åˆ°äº‹ä»¶: ${data.event_type || 'unknown'}`);
                    log(`äº‹ä»¶æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                    
                    if (data.event_type === 'tool_confirmation_needed') {
                        log('ğŸ”” æ”¶åˆ°å·¥å…·ç¡®è®¤è¯·æ±‚ï¼');
                        
                        // 3ç§’åè‡ªåŠ¨ç¡®è®¤
                        setTimeout(() => {
                            fetch('http://localhost:8000/chat/tool-confirm', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    session_id: 'tool-test',
                                    confirmed: true,
                                    tool_args: data.suggested_args || {}
                                })
                            }).then(response => response.json())
                            .then(result => {
                                log(`âœ… å·¥å…·ç¡®è®¤å·²å‘é€: ${JSON.stringify(result)}`);
                            })
                            .catch(error => {
                                log(`âŒ å·¥å…·ç¡®è®¤å¤±è´¥: ${error}`);
                            });
                        }, 3000);
                    }
                    
                } catch (e) {
                    log(`âŒ è§£æäº‹ä»¶å¤±è´¥: ${e.message}`);
                    log(`åŸå§‹æ•°æ®: ${event.data}`);
                }
            };
            
            eventSource.onerror = function(error) {
                log(`âŒ SSEé”™è¯¯: ${error}`);
            };
            
            // 60ç§’åå…³é—­è¿æ¥
            setTimeout(() => {
                eventSource.close();
                log('è¿æ¥å·²å…³é—­');
            }, 60000);
        }
    </script>
</body>
</html>
